<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ä½œæ¯æ™‚é˜">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />

<title>å¯¶å¯¶ä½œæ¯æ™‚é˜ - éœæ…‹åˆ†é˜ç’° (V17 - è¨­å®šé€£å‹•)</title>
<style>
  /* å…¨åŸŸè¨­å®š */
  body, html {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #fffafc;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    position: relative;
  }

  /* åœ“ç›¤ï¼šéœæ…‹åˆ†é˜ç’° (12 é»é˜åœ¨ä¸Šæ–¹ï¼Œä¸æ—‹è½‰) */
  .clock {
    position: relative;
    width: 380px;
    height: 380px;
    border-radius: 50%;
    box-shadow: 0 0 50px rgba(0,0,0,0.15);
    margin-bottom: 20px; 
    transition: background 0.5s ease-in-out; 
    transform-origin: center center;
    background: #f9f9f9; /* æ·ºç°è‰²ä½œç‚ºåº•è‰² */
  }

  /* æ™‚é˜æŒ‡é‡èˆ‡ä¸­å¿ƒé» */
  .minute-hand { 
    position: absolute; 
    width: 6px; 
    height: 160px; 
    background: #333; 
    top: 30px; 
    left: 50%; 
    transform-origin: bottom center; 
    border-radius: 3px; 
    z-index: 10; 
    transform: translateX(-50%); 
  }
  .center-dot { position: absolute; width: 16px; height: 16px; background: #333; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 11; border: 2px solid white; }

  /* ä»»å‹™æ¨™ç±¤å®¹å™¨ */
  #taskLabelsContainer {
    position: absolute;
    width: 380px;
    height: 380px;
    left: 50%; 
    top: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }
  
  /* ä»»å‹™æ¨™ç±¤ */
  .task-label { 
    position: absolute; 
    font-size: 13px; 
    font-weight: 500; 
    text-align: center; 
    transform: translate(-50%, -50%); 
    z-index: 5; 
    line-height: 1.3; 
    color: #444; 
    text-shadow: 0 1px 2px rgba(255,255,255,0.9); 
    pointer-events: none; 
    max-width: 80px; 
  }
  
  /* åˆ»åº¦èˆ‡æ•¸å­— */
  .tick { position: absolute; left: 50%; top: 0; background: rgba(0, 0, 0, 0.3); }
  .tick.minor { width: 1px; height: 6px; transform-origin: 50% 190px; }
  .tick.major { width: 3px; height: 12px; background: rgba(0, 0, 0, 0.6); transform-origin: 50% 190px; }
  
  /* æ•¸å­—æ¨™ç±¤ */
  .clock-label { 
    position: absolute; 
    font-weight: 800; 
    transform: translate(-50%, -50%); 
    z-index: 6; 
    font-feature-settings: "tnum"; 
    pointer-events: none; 
  }
  .zoom-minute-label { font-size: 18px; color: #666; } 

  /* æ™‚é–“é¡¯ç¤ºæ¡† */
  .current-time-box { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 15px 40px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid rgba(255,255,255,0.5); }
  .current-time { font-size: 40pt; font-weight: bold; color: #333; font-variant-numeric: tabular-nums; line-height: 1; }
  .date-label { font-size: 14pt; color: #888; margin-bottom: 8px; font-weight: 500; }
  .hour-range-indicator { font-size: 16pt; font-weight: bold; margin-top: 5px; color: #007aff; }

  /* --- è¨­å®šæŒ‰éˆ•èˆ‡å½ˆçª—æ¨£å¼ (ä¸è®Š) --- */
  #settingsBtn { position: absolute; top: 20px; right: 20px; background: white; padding: 10px; border-radius: 50%; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); font-size: 24px; line-height: 1; cursor: pointer; z-index: 50; }
  #settingsModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); z-index: 100; display: none; justify-content: center; align-items: center; overflow-y: auto; padding: 20px 0; }
  .modal-content { background: white; border-radius: 20px; width: 95%; max-width: 900px; max-height: 95%; overflow-y: auto; padding: 20px 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .modal-header h2 { color: #333; font-size: 28px; }
  .modal-actions button, .preset-actions button { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-left: 10px; }
  #saveSettingsBtn { background: #4CAF50; color: white; }
  #closeSettingsBtn { background: #f44336; color: white; }
  #loadPresetBtn { background: #2196F3; color: white; }
  #savePresetBtn { background: #FF9800; color: white; }
  #deletePresetBtn { background: #F44336; color: white; }
  #tasksTable { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
  #tasksTable th, #tasksTable td { padding: 10px 5px; text-align: center; border-bottom: 1px solid #eee; }
  #tasksTable input[type="text"] { padding: 5px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
  #tasksTable input[type="color"] { width: 30px; height: 30px; padding: 0; border: none; border-radius: 5px; vertical-align: middle; }
  /* é–å®šçš„æ¬„ä½ä½¿ç”¨ä¸åŒé¡è‰² */
  #tasksTable select[disabled] { background-color: #e0e0e0; border: 1px solid #999; color: #555; } 
  .time-select-group { display: flex; gap: 3px; justify-content: center; }
  .time-select-group select { width: 45%; padding: 5px; border: 1px solid #ccc; border-radius: 5px; }
  .preset-actions { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
</style>
</head>
<body>

<div id="settingsBtn">âš™ï¸</div>

<div id="clock" class="clock">
  <div class="minute-hand" id="minHand"></div>
  <div class="center-dot"></div>
</div>
<div id="taskLabelsContainer"></div>

<div class="current-time-box">
  <div id="date-label" class="date-label"></div>
  <div id="current-time" class="current-time"></div>
  <div id="hour-range-indicator" class="hour-range-indicator"></div> 
</div>

<div id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ä½œæ¯æ’ç¨‹è¨­å®š (åˆ†é˜ç²’åº¦)</h2>
            <div class="modal-actions">
                <button id="saveSettingsBtn">ğŸ’¾ å„²å­˜ä¸¦æ›´æ–°</button>
                <button id="closeSettingsBtn">âŒ é—œé–‰</button>
            </div>
        </div>
        
        <h3>è¨˜æ†¶çµ„ (Preset) ç®¡ç†</h3>
        <div class="preset-actions">
            <label>è¼‰å…¥/åˆ‡æ›ï¼š</label>
            <select id="presetSelector"></select>
            <button id="loadPresetBtn">è®€å–ä¸¦è¦†è“‹</button>
            <button id="deletePresetBtn">åˆªé™¤é¸å®šçµ„</button>
            
            <label style="margin-left: 20px;">å„²å­˜ç›®å‰ï¼š</label>
            <input type="text" id="newPresetName" placeholder="è¼¸å…¥æ–°è¨˜æ†¶çµ„åç¨±" style="width: 150px;"/>
            <button id="savePresetBtn">ğŸ’¾ å„²å­˜ç‚ºæ–°çµ„</button>
        </div>

        <h3>ä»»å‹™åˆ—è¡¨è¨­å®š (æœ€å¤š 10 çµ„)</h3>
        <p style="color: red; font-weight: bold;">âœ… ç¬¬ 2 é …ä¹‹å¾Œçš„ä»»å‹™ï¼Œé–‹å§‹æ™‚é–“æœƒé–å®šä¸¦é€£å‹•å‰ä¸€é …çš„çµæŸæ™‚é–“ã€‚</p>
        <table id="tasksTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>å•Ÿç”¨</th>
                    <th>ä»»å‹™åç¨±</th>
                    <th>Emoji</th>
                    <th>é¡è‰²</th>
                    <th>é–‹å§‹æ™‚é–“ (å°æ™‚:åˆ†é˜)</th>
                    <th>çµæŸæ™‚é–“ (å°æ™‚:åˆ†é˜)</th>
                </tr>
            </thead>
            <tbody id="tasksBody">
                </tbody>
        </table>
        
        <h3 style="margin-top: 20px;">è·¨è£ç½®åŒæ­¥è³‡è¨Š (è«‹è¤‡è£½æ­¤ç¶²å€)</h3>
        <p>è«‹å°‡ä¸‹æ–¹ç¶²å€è¤‡è£½åˆ°æ‚¨æ‰€æœ‰è£ç½®ï¼Œå³å¯åŒæ­¥æ‚¨çš„è¨­å®šï¼š</p>
        <input type="text" id="syncUrlDisplay" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 5px;" readonly>
    </div>
</div>

<script>
// --- é›²ç«¯åŒæ­¥è¨­å®š ---
// âš ï¸ è«‹ç¢ºä¿é€™è£¡çš„ KEY å’Œ BIN_ID èˆ‡æ‚¨çš„ jsonbin.io è³‡è¨Šä¸€è‡´
const X_MASTER_KEY = '$2a$10$Ud6ejIFrOHIeYjhVKcVE5.PG9rQKTWbsfFd0RuYmxubPyt2bjV5yS'; 
const BIN_ID = '6924168743b1c97be9c18709'; 
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

// --- æ ¸å¿ƒæ•¸æ“šèˆ‡æ¨¡å¼è¨­å®š ---
const MAX_TASKS = 10;
const FULL_DAY_MINUTES = 1440; 
const ZOOM_DEGREE = 360 / 60; // 6 åº¦/åˆ†é˜ (ä¸€åˆ†é˜ 6 åº¦)

const MODE_ZOOM_FORCED = 'ZOOM_FORCED'; 

let currentTasks = [];
let presets = {};
let displayMode = 'ZOOM'; 
let controlMode = MODE_ZOOM_FORCED; 
let zoomStartMinutes = 0; // ç•¶å‰ç¸®æ”¾å°æ™‚çš„èµ·å§‹åˆ†é˜æ•¸ (ä¾‹å¦‚ 17:00 å°±æ˜¯ 1020)
let configId = BIN_ID; 

// é è¨­æ•¸æ“š
const DEFAULT_TASKS = [
    { name: 'èµ·åºŠ', emoji: 'ğŸŒ', color: '#ffd6e8', start: 420, end: 430, enabled: true },      
    { name: 'ç©¿è¡£æœ', emoji: 'ğŸ‘•', color: '#fdd9c7', start: 430, end: 440, enabled: true },    
    { name: 'æ•´ç†æ›¸åŒ…', emoji: 'ğŸ’', color: '#ffecc7', start: 440, end: 445, enabled: true },    
    { name: 'åƒæ—©é¤', emoji: 'ğŸ¥£', color: '#d6eaff', start: 445, end: 460, enabled: true },    
    { name: 'æ•´ç†é¤æ¡Œã€æ“¦å˜´å·´', emoji: 'ğŸ½ï¸', color: '#e5ffd6', start: 460, end: 465, enabled: true },
    { name: 'ç©¿é‹å­', emoji: 'ğŸ‘Ÿ', color: '#ffdfd6', start: 465, end: 470, enabled: true },    
    { name: 'å‡ºé–€', emoji: 'ğŸš¶', color: '#ffc7d9', start: 470, end: 475, enabled: true },  
    { name: 'ä¸Šå­¸', emoji: 'ğŸ«', color: '#c7d9ff', start: 475, end: 1020, enabled: true },  
    { name: 'å›å®¶', emoji: 'ğŸ ', color: '#e8d6ff', start: 1020, end: 1260, enabled: true },
    { name: 'ç¡è¦º', emoji: 'ğŸ˜´', color: '#f0f0f0', start: 1260, end: 420, enabled: true }         
];
const DEFAULT_PRESET_NAME = 'é è¨­ä½œæ¯';
const DEFAULT_CLOUD_DATA = { 
    tasks: DEFAULT_TASKS,
    presets: { [DEFAULT_PRESET_NAME]: DEFAULT_TASKS }
};


// --- æ™‚é–“è™•ç†èˆ‡å·¥å…·å‡½å¼ ---
function minutesToHHMM(totalMinutes) {
    // ç¢ºä¿è™•ç† 1440
    if (totalMinutes === 1440) return '24:00';
    totalMinutes = totalMinutes % 1440;
    const hour = Math.floor(totalMinutes / 60);
    const minute = totalMinutes % 60;
    return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
}

function minutesToTime(totalMinutes) {
    if (typeof totalMinutes !== 'number' || isNaN(totalMinutes) || totalMinutes < 0) {
        totalMinutes = 0; 
    }
    
    // è™•ç† 1440 (24:00)
    if (totalMinutes === 1440) return { hour: 24, minute: 0 }; 
    const hour = Math.floor(totalMinutes / 60) % 24;
    const minute = totalMinutes % 60;
    return { hour, minute };
}

/**
 * ç”¢ç”Ÿå°æ™‚/åˆ†é˜ä¸‹æ‹‰é¸å–®
 * @param {number} dataIndex ä»»å‹™ç´¢å¼•
 * @param {string} fieldPrefix 'start' or 'end'
 * @param {number} totalMinutes ç¸½åˆ†é˜æ•¸
 * @param {boolean} isEnd æ˜¯å¦ç‚ºçµæŸæ™‚é–“
 * @param {boolean} isDisabled æ˜¯å¦ç¦ç”¨
 */
function generateTimeSelectors(dataIndex, fieldPrefix, totalMinutes, isEnd, isDisabled = false) {
    if (typeof totalMinutes !== 'number' || isNaN(totalMinutes) || totalMinutes < 0) {
        totalMinutes = 0; 
    }
    let { hour, minute } = minutesToTime(totalMinutes);
    
    let hourOptions = '';
    const maxHour = isEnd ? 24 : 23; 
    for (let h = 0; h <= maxHour; h++) {
        // ç¢ºä¿ 24:00 åœ¨çµæŸæ™‚é–“é¸é …ä¸­
        if (h === 24 && !isEnd) continue;
        hourOptions += `<option value="${h}" ${h === hour ? 'selected' : ''}>${h.toString().padStart(2, '0')}</option>`;
    }

    let minuteOptions = '';
    for (let m = 0; m <= 59; m += 5) { 
        minuteOptions += `<option value="${m}" ${m === minute ? 'selected' : ''}>${m.toString().padStart(2, '0')}</option>`;
    }
    
    const disabledAttr = isDisabled ? 'disabled' : '';

    return `<div class="time-select-group">
        <select ${disabledAttr} data-index="${dataIndex}" data-field="${fieldPrefix}Hour">${hourOptions}</select>
        <select ${disabledAttr} data-index="${dataIndex}" data-field="${fieldPrefix}Minute">${minuteOptions}</select>
    </div>`;
}

/**
 * è™•ç†è·¨æ—¥å•é¡Œï¼šå°‡ä¸€å€‹ä»»å‹™æ™‚é–“å€é–“ (start, end) åˆ†å‰²æˆä¸€å€‹æˆ–å…©å€‹éè·¨è¶Š 0 é» (0/1440) çš„æœ‰æ•ˆæ®µã€‚
 * @param {number} start 
 * @param {number} end 
 * @returns {Array<Object>} {start, end} å€é–“é™£åˆ—
 */
function getTaskSegments(start, end) {
    let segments = [];
    if (start === end) {
        if (start === 0 && end === FULL_DAY_MINUTES) {
            segments.push({ start: 0, end: FULL_DAY_MINUTES });
        }
    } else if (start > end) {
        // è·¨æ—¥ä»»å‹™: (23:00 -> 07:00) è®Šæˆ (23:00 -> 24:00) å’Œ (00:00 -> 07:00)
        segments.push({ start: start, end: FULL_DAY_MINUTES });
        segments.push({ start: 0, end: end });
    } else {
        segments.push({ start: start, end: end });
    }
    return segments.filter(s => s.end > s.start);
}


// --- æ•¸æ“šè¼‰å…¥/å„²å­˜é‚è¼¯ (ä¸è®Š) ---
async function loadData() {
    controlMode = MODE_ZOOM_FORCED; 
    displayMode = 'ZOOM';

    try {
        const response = await fetch(JSONBIN_URL, {
            headers: {
                'X-Master-Key': X_MASTER_KEY,
                'Content-Type': 'application/json'
            }
        });
        if (!response.ok) throw new Error(`Cloud load failed: ${response.status}`);
        const data = await response.json();
        const cloudData = data.record; 

        if (cloudData && cloudData.tasks && cloudData.presets) {
            currentTasks = JSON.parse(JSON.stringify(cloudData.tasks));
            presets = cloudData.presets;
        } else {
            currentTasks = JSON.parse(JSON.stringify(DEFAULT_TASKS));
            presets = DEFAULT_CLOUD_DATA.presets;
        }
        
    } catch (error) {
        console.error("è¼‰å…¥é›²ç«¯æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­å€¼:", error);
        currentTasks = JSON.parse(JSON.stringify(DEFAULT_TASKS));
        presets = DEFAULT_CLOUD_DATA.presets;
    }
}


async function saveCloudData(tasksToSave, presetsToSave) {
    const finalTasks = JSON.parse(JSON.stringify(tasksToSave));
    // å„²å­˜å‰å†æ¬¡å¼·åˆ¶é€£å‹•
    for (let i = 1; i < finalTasks.length; i++) {
        if (finalTasks[i-1].enabled) {
            finalTasks[i].start = finalTasks[i-1].end;
        }
    }
    
    const payload = { tasks: finalTasks, presets: presetsToSave };
    try {
        const response = await fetch(JSONBIN_URL, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': X_MASTER_KEY,
                'X-Bin-Versioning': false 
            },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`Cloud save failed: ${response.status}`);
        updateSyncUrlDisplay();
        return true;
    } catch (error) {
        console.error("å„²å­˜é›²ç«¯æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
        alert('âŒ é›²ç«¯åŒæ­¥å¤±æ•—ï¼');
        return false;
    }
}

function updateSyncUrlDisplay() {
    const baseUrl = window.location.href.split('?')[0];
    document.getElementById('syncUrlDisplay').value = `${baseUrl}?configId=${configId}`;
}


// --- æ™‚é˜æ¸²æŸ“é‚è¼¯ (V16/V17 ä¿æŒ) ---
const clockElement = document.getElementById('clock');
const hourRangeIndicator = document.getElementById('hour-range-indicator'); 
const labelsContainer = document.getElementById('taskLabelsContainer'); 
const cx = 190; const cy = 190; 
const R_TASK_LABEL_OUTER = 125; 
const R_CLOCK_LABEL = 175; 

function renderClock() {
    // 1. æ¸…ç†
    clockElement.innerHTML = `<div class="minute-hand" id="minHand"></div><div class="center-dot"></div>`;
    labelsContainer.innerHTML = ''; 

    let conicGradientStops = [];
    let enabledTasks = currentTasks.filter(t => t.enabled);
    
    const degreePerMinute = ZOOM_DEGREE; 
    const zoomEndMinutes = zoomStartMinutes + 60;
    
    // è¨­ç½®ä¸€å€‹åº•è‰² (å¾ 12 é»é˜æ–¹å‘ 0 åº¦é–‹å§‹åˆ° 360 åº¦)
    conicGradientStops.push(`#f9f9f9 0deg 360deg`);

    hourRangeIndicator.textContent = `${minutesToHHMM(zoomStartMinutes)} - ${minutesToHHMM(zoomEndMinutes)}`;

    // è¼”åŠ©å‡½æ•¸ï¼šå¢åŠ æ¨™ç±¤
    function addLabel(task, middleAngleDeg, durationMinutes) {
        const div = document.createElement('div');
        div.className = 'task-label';
        
        div.innerHTML = durationMinutes < 10 ? `${task.emoji}` : `${task.emoji}<br>${task.name}`;
       
        const radius = R_TASK_LABEL_OUTER; 
        
        // è§’åº¦è½‰æ›: åœ“ç›¤è§’åº¦ (0 deg at 12) -> ç¬›å¡çˆ¾è§’åº¦ (90 deg at 12)
        let angleRad = (middleAngleDeg - 90) * Math.PI / 180;
        
        div.style.left = `${cx + radius * Math.cos(angleRad)}px`;
        div.style.top = `${cy + radius * Math.sin(angleRad)}px`; 
        
        labelsContainer.appendChild(div);
    }
    
    // æ¸²æŸ“è¿´åœˆ
    enabledTasks.forEach(task => {
        
        const segments = getTaskSegments(task.start, task.end);

        segments.forEach(segment => {
            let start = segment.start; 
            let end = segment.end;
            
            // è£å‰ªä»»å‹™æ™‚é–“å€é–“åˆ°ç•¶å‰å°æ™‚ (zoomStartMinutes åˆ° zoomEndMinutes)
            let clippedStart = Math.max(start, zoomStartMinutes);
            let clippedEnd = Math.min(end, zoomEndMinutes);
            
            if (clippedEnd <= clippedStart) return; 
            
            // è¨ˆç®—åœ¨ç•¶å‰ 60 åˆ†é˜å€é–“å…§çš„ç›¸å°èµ·å§‹å’ŒçµæŸåˆ†é˜æ•¸ (0-60)
            let relativeStartMinutes = clippedStart - zoomStartMinutes; 
            let relativeEndMinutes = clippedEnd - zoomStartMinutes;     
            let durationMinutes = relativeEndMinutes - relativeStartMinutes;

            // è§’åº¦è¨ˆç®—
            let gradientStartDeg = relativeStartMinutes * degreePerMinute;
            let gradientStopDeg = relativeEndMinutes * degreePerMinute; 
            
            // ç¢ºä¿è§’åº¦åœ¨ 0 åˆ° 360 åº¦ä¹‹é–“
            gradientStartDeg = Math.max(0, gradientStartDeg);
            gradientStopDeg = Math.min(360, gradientStopDeg);

            if (gradientStopDeg > gradientStartDeg) {
                // å°‡è‰²å¡Šæ’å…¥åˆ° conicGradientStops
                conicGradientStops.push(`${task.color} ${gradientStartDeg}deg ${gradientStopDeg}deg`);
                
                let middleMinutes = relativeStartMinutes + durationMinutes / 2;
                let middleAngleDeg = middleMinutes * degreePerMinute;
                
                addLabel(task, middleAngleDeg, durationMinutes);
            }
        });
    });

    // è¨­ç½®åœ“ç’°èƒŒæ™¯
    const finalGradientStops = conicGradientStops.filter((_, i) => i > 0).join(', '); 
    clockElement.style.background = `conic-gradient(from 0deg, ${conicGradientStops[0]}, ${finalGradientStops})`;
    
    
    // ç¹ªè£½åˆ»åº¦èˆ‡æ•¸å­— (1H Zoom Mode)
    for (let i = 0; i < 60; i += 5) {
        const isMajor = i % 15 === 0;
        const labelText = i.toString().padStart(2, '0');
        const deg = i * 6; // 6åº¦/åˆ†é˜
        
        const tick = document.createElement('div');
        tick.className = 'tick ' + (isMajor ? 'major' : 'minor');
        tick.style.transform = `translateX(-50%) rotate(${deg}deg)`;
        clockElement.appendChild(tick);
        
        if (isMajor) {
            const num = document.createElement('div');
            num.className = 'clock-label zoom-minute-label';
            num.textContent = `${labelText}`; 
            
            // æ•¸å­—æ¨™ç±¤å®šä½
            const angleRad = (deg - 90) * Math.PI / 180;
            
            num.style.left = `${cx + R_CLOCK_LABEL * Math.cos(angleRad)}px`;
            num.style.top = `${cy + R_CLOCK_LABEL * Math.sin(angleRad)}px`; 
            labelsContainer.appendChild(num);
        }
    }
}


function updateTime() {
    const now = new Date();
    const h = now.getHours();
    const m = now.getMinutes();
    const s = now.getSeconds();
    
    // ç¸½åˆ†é˜æ•¸ (åŒ…å«ç§’æ•¸)
    const currentTotalMinutes = (h * 60) + m + (s / 60);
    // ç•¶å‰å°æ™‚çš„èµ·å§‹åˆ†é˜æ•¸ (ä¾‹å¦‚ 17:30:14 -> 17:00 -> 1020)
    const currentHourStart = Math.floor(currentTotalMinutes / 60) * 60; 
    
    const oldZoomStartMinutes = zoomStartMinutes;
    zoomStartMinutes = currentHourStart; 

    // å¦‚æœå°æ™‚åˆ‡æ›äº†ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“æ•´å€‹æ™‚é˜è‰²å¡Š
    if (zoomStartMinutes !== oldZoomStartMinutes) {
        renderClock();
    }
    
    // è¨ˆç®—ç•¶å‰åˆ†é˜åœ¨ç•¶å‰å°æ™‚å…§çš„ç¸½åˆ†é˜æ•¸ (åŒ…å«ç§’æ•¸)
    const minutesInHour = currentTotalMinutes - zoomStartMinutes;
    
    // æŒ‡é‡æ—‹è½‰è§’åº¦ (å¾ 12 é»é˜æ–¹å‘ 0 åº¦é–‹å§‹é †æ™‚é‡æ—‹è½‰)
    const rotationDegree = minutesInHour * ZOOM_DEGREE;
    
    const finalHandRotation = rotationDegree;
    
    document.getElementById('minHand').style.transform = `translateX(-50%) rotate(${finalHandRotation}deg)`;
    
    document.getElementById('current-time').textContent = 
        `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    const dateStr = now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });
    document.getElementById('date-label').textContent = dateStr;
}


// --- è¨­å®šä»‹é¢æ¸²æŸ“èˆ‡äº’å‹• (V17 ä¿®æ­£) ---

const tasksBody = document.getElementById('tasksBody');
const modal = document.getElementById('settingsModal');
const presetSelector = document.getElementById('presetSelector');


/**
 * æ ¹æ“šå‰ä¸€é …ä»»å‹™çš„çµæŸæ™‚é–“æ›´æ–°ç•¶å‰ä»»å‹™çš„é–‹å§‹æ™‚é–“é¸æ“‡å™¨
 * @param {number} taskIndex ç•¶å‰ä»»å‹™ç´¢å¼•
 * @param {number} newStartMinutes æ–°çš„é–‹å§‹ç¸½åˆ†é˜æ•¸
 */
function updateStartTimeSelector(taskIndex, newStartMinutes) {
    const row = tasksBody.querySelector(`tr:nth-child(${taskIndex + 1})`);
    if (!row) return;

    const startHourSelect = row.querySelector('[data-field="startHour"]');
    const startMinuteSelect = row.querySelector('[data-field="startMinute"]');

    if (startHourSelect && startMinuteSelect && startHourSelect.disabled) {
        const { hour, minute } = minutesToTime(newStartMinutes);

        // æ›´æ–°å°æ™‚é¸å–®
        startHourSelect.value = hour;
        
        // æ›´æ–°åˆ†é˜é¸å–® (å¼·åˆ¶ 5 åˆ†é˜é–“éš”)
        const roundedMinute = Math.round(minute / 5) * 5;
        // ç¢ºä¿é¸å–®ä¸­å·²ç¶“æœ‰é€™å€‹å€¼
        if (startMinuteSelect.querySelector(`option[value="${roundedMinute}"]`)) {
             startMinuteSelect.value = roundedMinute;
        } else {
             // è™•ç†ä¾‹å¦‚ 24:00 (1440) é€™ç¨®ç‰¹æ®Šæƒ…æ³, å®ƒçš„åˆ†é˜æ˜¯ 0
             startMinuteSelect.value = 0; 
        }
    }
}


function renderSettings() {
    tasksBody.innerHTML = '';
    
    // V17: å»ºç«‹ä¸€å€‹é€£å‹•å¾Œçš„ä»»å‹™å‰¯æœ¬ï¼Œç”¨æ–¼æ¸²æŸ“
    const tasksToRender = JSON.parse(JSON.stringify(currentTasks));
    for (let i = 1; i < tasksToRender.length; i++) {
        // åªæœ‰å‰ä¸€å€‹ä»»å‹™å•Ÿç”¨æ™‚æ‰é€£å‹•
        if (tasksToRender[i-1].enabled) {
             tasksToRender[i].start = tasksToRender[i-1].end;
        }
    }


    for (let i = 0; i < MAX_TASKS; i++) {
        const task = tasksToRender[i] || { name: '', emoji: '', color: '#f0f0f0', start: 0, end: 0, enabled: false };
        
        // V17: åˆ¤æ–·æ˜¯å¦é–å®šé–‹å§‹æ™‚é–“ï¼š
        // 1. ä¸æ˜¯ç¬¬ä¸€å€‹ä»»å‹™ (i > 0)
        // 2. ä¸”å‰ä¸€å€‹ä»»å‹™æ˜¯å•Ÿç”¨çš„ (tasksToRender[i-1].enabled)
        const isStartLocked = i > 0 && tasksToRender[i-1] && tasksToRender[i-1].enabled; 

        // é–å®šçš„è©±ï¼Œä½¿ç”¨é€£å‹•å¾Œçš„ task.start æ¸²æŸ“
        const startTimeSelectors = generateTimeSelectors(i, 'start', task.start, false, isStartLocked);
        const endTimeSelectors = generateTimeSelectors(i, 'end', task.end, true, false); 

        let row = `<tr data-index="${i}">
            <td>${i + 1}</td>
            <td><input type="checkbox" data-index="${i}" data-field="enabled" ${task.enabled ? 'checked' : ''}></td>
            <td><input type="text" data-index="${i}" data-field="name" value="${task.name || ''}" placeholder="ä¾‹å¦‚: åƒæ—©é¤"></td>
            <td><input type="text" data-index="${i}" data-field="emoji" value="${task.emoji || ''}" maxlength="2" style="width: 50px;" placeholder="åœ–ç¤º"></td>
            <td><input type="color" data-index="${i}" data-field="color" value="${task.color || '#f0f0f0'}"></td>
            <td>${startTimeSelectors}</td>
            <td>${endTimeSelectors}</td>
        </tr>`;
        tasksBody.innerHTML += row;
    }
    
    // V17: åœ¨æ¸²æŸ“å®Œæˆå¾Œï¼Œç‚ºæ‰€æœ‰ end æ™‚é–“é¸æ“‡å™¨æ·»åŠ è®Šå‹•äº‹ä»¶ç›£è½å™¨
    addSettingsEventListeners();

    renderPresetSelector();
    updateSyncUrlDisplay(); 
}

function addSettingsEventListeners() {
    tasksBody.querySelectorAll('select[data-field$="Hour"], select[data-field$="Minute"], input[data-field="enabled"]').forEach(input => {
        input.addEventListener('change', handleSettingChange);
    });
}

function handleSettingChange(event) {
    const target = event.target;
    const index = parseInt(target.getAttribute('data-index'), 10);
    const field = target.getAttribute('data-field');
    const tasks = Array.from(tasksBody.querySelectorAll('tr')).map(row => {
        const hS = row.querySelector('[data-field="startHour"]').value;
        const mS = row.querySelector('[data-field="startMinute"]').value;
        const hE = row.querySelector('[data-field="endHour"]').value;
        const mE = row.querySelector('[data-field="endMinute"]').value;
        
        const enabled = row.querySelector('[data-field="enabled"]').checked;
        
        let startM = (parseInt(hS, 10) * 60) + parseInt(mS, 10);
        let endM = (parseInt(hE, 10) * 60) + parseInt(mE, 10);
        
        if (parseInt(hE, 10) === 24) endM = FULL_DAY_MINUTES;

        return { start: startM, end: endM, enabled: enabled };
    });


    // å¦‚æœæ˜¯æ›´æ”¹ã€Œå•Ÿç”¨ã€ç‹€æ…‹
    if (field === 'enabled') {
        // é‡æ–°æ¸²æŸ“è¨­å®šä»‹é¢ä»¥é–å®š/è§£é–ä¸‹ä¸€é …çš„é–‹å§‹æ™‚é–“
        renderSettings();
        return; 
    }

    // åªæœ‰æ›´æ”¹ã€ŒçµæŸæ™‚é–“ã€æ™‚æ‰éœ€è¦é€£å‹•ä¸‹ä¸€é …
    if (field === 'endHour' || field === 'endMinute') {
        const nextTaskIndex = index + 1;
        if (nextTaskIndex < MAX_TASKS) {
             const nextTaskRow = tasksBody.querySelector(`tr[data-index="${nextTaskIndex}"]`);
             if (nextTaskRow && tasks[index].enabled) {
                 // ç²å–ç•¶å‰ä»»å‹™æœ€æ–°çš„çµæŸæ™‚é–“
                 const newEndMinutes = tasks[index].end;
                 
                 // æ›´æ–°ä¸‹ä¸€é …çš„é–‹å§‹æ™‚é–“é¡¯ç¤º
                 updateStartTimeSelector(nextTaskIndex, newEndMinutes);
             }
        }
    }
    
    // å¦‚æœæ˜¯æ›´æ”¹ç¬¬ä¸€é …ä»»å‹™çš„é–‹å§‹æ™‚é–“ï¼Œéœ€è¦æª¢æŸ¥å…¶çµæŸæ™‚é–“æ˜¯å¦é‚„åœ¨æœ‰æ•ˆå€é–“
    if (index === 0 && (field === 'startHour' || field === 'startMinute')) {
        // ... (é€™è£¡å¯ä»¥æ·»åŠ é¡å¤–çš„é©—è­‰ï¼Œä½†ç›®å‰ä¸»è¦ç›®çš„æ˜¯é€£å‹•)
    }
}


async function applySettings() {
    const newTasks = [];
    let isValid = true;
    
    tasksBody.querySelectorAll('tr').forEach((row, i) => {
        const enabled = row.querySelector('[data-field="enabled"]').checked;
        const name = row.querySelector('[data-field="name"]').value.trim();
        const emoji = row.querySelector('[data-field="emoji"]').value.trim();
        const color = row.querySelector('[data-field="color"]').value;
        
        // ç”±æ–¼é–‹å§‹æ™‚é–“å¯èƒ½è¢«é–å®šï¼Œé€™è£¡éœ€è¦è®€å–å¯¦éš›çš„é¸æ“‡å™¨çš„å€¼ï¼Œè€Œä¸æ˜¯è¢«é–å®šçš„å€¼
        const startHourElement = row.querySelector('[data-field="startHour"]');
        const startMinuteElement = row.querySelector('[data-field="startMinute"]');
        const endHourElement = row.querySelector('[data-field="endHour"]');
        const endMinuteElement = row.querySelector('[data-field="endMinute"]');
        
        if (!startHourElement || !startMinuteElement || !endHourElement || !endMinuteElement) {
             isValid = false;
             return;
        }
        
        const startHour = parseInt(startHourElement.value, 10);
        const startMinute = parseInt(startMinuteElement.value, 10);
        const endHour = parseInt(endHourElement.value, 10);
        const endMinute = parseInt(endMinuteElement.value, 10);
        
        const startMinutes = (startHour * 60) + startMinute;
        let endMinutes = (endHour * 60) + endMinute;

        if (endHour === 24) {
            endMinutes = FULL_DAY_MINUTES; 
        }

        const task = { enabled, name, emoji, color, start: startMinutes, end: endMinutes };
        
        if (task.enabled) {
            if (!task.name) {
                alert(`ç¬¬ ${i + 1} è¡Œå·²å•Ÿç”¨ï¼Œä½†ä»»å‹™åç¨±ä¸èƒ½ç‚ºç©ºï¼`);
                isValid = false;
                return;
            }
            // åªæª¢æŸ¥ç¬¬ä¸€é …çš„è·¨æ—¥é‚è¼¯ï¼Œå¾ŒçºŒé …ç›®æœƒåœ¨é€£å‹•å¾Œæª¢æŸ¥
            if (i === 0 && task.start >= task.end && task.end !== FULL_DAY_MINUTES) {
                 alert(`ç¬¬ ${i + 1} è¡Œ (ç¬¬ä¸€é …ä»»å‹™) çš„æ™‚é–“å€é–“ç„¡æ•ˆ (é–‹å§‹/çµæŸæ™‚é–“ç›¸åŒæˆ–ç„¡è·¨æ—¥)ï¼`);
                 isValid = false;
                 return;
            }
        }
        newTasks.push(task);
    });

    if (!isValid) return false; 
    
    // V17: å†æ¬¡åŸ·è¡Œé€£å‹•å’Œæª¢æŸ¥é‚è¼¯
    for (let i = 1; i < newTasks.length; i++) {
        if (newTasks[i-1].enabled) {
            newTasks[i].start = newTasks[i-1].end; // å¼·åˆ¶é€£å‹•
            
            // æª¢æŸ¥é€£å‹•å¾Œçš„çµæŸæ™‚é–“æ˜¯å¦æœ‰æ•ˆ
            if (newTasks[i].enabled && newTasks[i].start >= newTasks[i].end && newTasks[i].end !== FULL_DAY_MINUTES) {
                 alert(`ç¬¬ ${i + 1} è¡Œçš„é–‹å§‹æ™‚é–“ (${minutesToHHMM(newTasks[i].start)}) å·²è¢«å‰ä¸€é …é–å®šï¼Œä½†å…¶çµæŸæ™‚é–“ (${minutesToHHMM(newTasks[i].end)}) å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼è«‹ä¿®æ”¹çµæŸæ™‚é–“ã€‚`);
                 isValid = false;
                 return;
            }
        }
    }
    if (!isValid) return false; 

    currentTasks = newTasks; 
    
    // å„²å­˜æ™‚ï¼Œé€£å‹•å¾Œçš„ newTasks æœƒè¢«ç™¼é€åˆ° saveCloudData
    const saved = await saveCloudData(currentTasks, presets);

    if (saved) {
        // é‡æ–°å¾é›²ç«¯åŠ è¼‰ï¼Œç¢ºä¿æ•¸æ“šæ˜¯æœ€çµ‚é–å®šçš„ç‰ˆæœ¬
        currentTasks = JSON.parse(JSON.stringify(await getCurrentTasksFromCloud())); 

        updateTime(); 
        modal.style.display = 'none'; 
        alert('âœ… è¨­å®šå·²å„²å­˜ä¸¦åŒæ­¥åˆ°é›²ç«¯ï¼');
        return true;
    }
    return false; 
}


async function getCurrentTasksFromCloud() {
    try {
        const response = await fetch(JSONBIN_URL, { headers: { 'X-Master-Key': X_MASTER_KEY } });
        if (!response.ok) return currentTasks; 
        const data = await response.json();
        return data.record.tasks || currentTasks;
    } catch (e) {
        return currentTasks;
    }
}


function renderPresetSelector() {
    presetSelector.innerHTML = '';
    const names = Object.keys(presets);
    if (names.length === 0) {
        presetSelector.innerHTML = '<option>ç„¡è¨˜æ†¶çµ„</option>';
        document.getElementById('loadPresetBtn').disabled = true;
        document.getElementById('deletePresetBtn').disabled = true;
        return;
    }
    document.getElementById('loadPresetBtn').disabled = false;
    document.getElementById('deletePresetBtn').disabled = false;
    
    names.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        presetSelector.appendChild(option);
    });
}

// --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ (ä¸è®Š) ---

document.addEventListener('DOMContentLoaded', async () => {
    await loadData(); 
    
    renderClock();
    
    function animate() {
        updateTime();
        requestAnimationFrame(animate); 
    }
    requestAnimationFrame(animate);

    document.getElementById('settingsBtn').addEventListener('click', () => {
        try {
            renderSettings();
            modal.style.display = 'flex';
        } catch (error) {
            console.error("é–‹å•Ÿè¨­å®šå½ˆçª—æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            modal.style.display = 'flex'; 
            alert("âš ï¸ é–‹å•Ÿè¨­å®šç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å° (Console)ã€‚");
        }
    });
    
    document.getElementById('closeSettingsBtn').addEventListener('click', () => { modal.style.display = 'none'; });
    document.getElementById('saveSettingsBtn').addEventListener('click', applySettings);

    document.getElementById('loadPresetBtn').addEventListener('click', () => {
        const name = presetSelector.value;
        if (confirm(`ç¢ºå®šè¦è¼‰å…¥ã€Œ${name}ã€å—ï¼Ÿç›®å‰çš„è¨­å®šå°‡æœƒè¢«è¦†è“‹ï¼`)) {
            currentTasks = JSON.parse(JSON.stringify(presets[name])); 
            renderSettings();
            alert('è¨˜æ†¶çµ„è¼‰å…¥æˆåŠŸï¼è«‹é»æ“Šã€Œå„²å­˜ä¸¦æ›´æ–°ã€åŒæ­¥åˆ°é›²ç«¯ã€‚');
        }
    });

    document.getElementById('savePresetBtn').addEventListener('click', async () => {
        const nameInput = document.getElementById('newPresetName');
        const name = nameInput.value.trim();
        if (!name) { alert('è«‹è¼¸å…¥è¨˜æ†¶çµ„åç¨±ï¼'); return; }
        if (presets[name] && !confirm(`è¨˜æ†¶çµ„ã€Œ${name}ã€å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) { return; }
        
        const applied = await applySettings(); 
        if (!applied) return; 
        
        presets[name] = JSON.parse(JSON.stringify(currentTasks)); 
        const saved = await saveCloudData(currentTasks, presets);
        
        if (saved) {
            renderPresetSelector();
            nameInput.value = '';
            alert(`âœ… ä½œæ¯å·²æˆåŠŸå„²å­˜ç‚ºè¨˜æ†¶çµ„ã€Œ${name}ã€ä¸¦åŒæ­¥åˆ°é›²ç«¯ï¼`);
        }
    });

    document.getElementById('deletePresetBtn').addEventListener('click', async () => {
        const name = presetSelector.value;
        if (confirm(`ç¢ºå®šè¦åˆªé™¤è¨˜æ†¶çµ„ã€Œ${name}ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸï¼`)) {
            delete presets[name];
            const saved = await saveCloudData(currentTasks, presets);
            
            if (saved) {
                renderPresetSelector();
                alert('âœ… è¨˜æ†¶çµ„å·²åˆªé™¤ä¸¦åŒæ­¥åˆ°é›²ç«¯ã€‚');
            }
        }
        if (zoomStartMinutes !== 0) {
            renderClock();
        }
    });
});
</script>

</body>
</html>